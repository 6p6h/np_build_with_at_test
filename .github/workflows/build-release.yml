name: "Build NewPipe release"

on:
  workflow_dispatch:
    inputs:
      upstream_tag:
        description: "Upstream tag to build"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout self repo
        uses: actions/checkout@v6

      - name: Clone upstream NewPipe
        run: |
          set -e

          git clone --branch "${{ inputs.upstream_tag }}" \
            https://github.com/TeamNewPipe/NewPipe.git upstream

          EXT_TAG=$(awk -F'"' \
            '/^\s*teamnewpipe-newpipe-extractor/ {print $2}' \
            upstream/gradle/libs.versions.toml)

          echo "Extractor tag: $EXT_TAG"

          git clone --branch "$EXT_TAG" \
            https://github.com/TeamNewPipe/NewPipeExtractor.git NewPipeExtractor

      - name: Setup Java & Gradle cache
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Apply patch
        run: |
          python3 scripts/apply_patch.py \
            --newpipe upstream \
            --extractor NewPipeExtractor

      - name: Build release APK
        run: |
          cd upstream
          ./gradlew assembleRelease --stacktrace
          
      - name: Sign app APK
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: upstream/app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.MY_KEYSTORE_B64 }}
          alias: NPR
          keyStorePassword: ${{ secrets.KEY_PASS }}
          keyPassword: ${{ secrets.KEY_PASS }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"

      - name: Generate latest.json
        run: |
          cd upstream
          
          rm app/build/outputs/apk/release/app-release-unsigned.apk

          python3 ../scripts/generate_json.py \
            --apk app/build/outputs/apk/release/*signed.apk \
            --version "$(jq -r '.elements[0].versionName' app/build/outputs/apk/release/output-metadata.json)" \
            --version-code "$(jq -r '.elements[0].versionCode' app/build/outputs/apk/release/output-metadata.json)"
          cat latest.json

      - name: Upload build artifact for testing
        uses: actions/upload-artifact@v6
        with:
          name: NewPipe-APK-test
          path: upstream/app/build/outputs/apk/release/*

      # - name: "Upload release & JSON"
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     files: |
      #       upstream/app/build/outputs/apk/release/*.apk
      #       upstream/latest.json
      #     tag_name: ${{ github.event.inputs.upstream_tag }}  # 或固定 latest
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

